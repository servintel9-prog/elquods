<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حمام القدس — شاشة العرض</title>

  <style>
    :root{
      --bg:#0b1020; --muted:#93a4c7; --text:#e8eefc;
      --ok:#2dd4bf; --warn:#fbbf24; --bad:#ef4444;
      --border:rgba(255,255,255,.08); --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --safe: 24px;
    }
    body{
    padding: var(--safe);
  }
    *{box-sizing:border-box}

    /* خلفية بصورة + طبقة تعتيم لرفع وضوح النص */
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      background:
        linear-gradient(0deg, rgba(11,16,32,.68), rgba(11,16,32,.68)),
        url("./assets/images1.jpeg") center/cover no-repeat;
    }

    header{max-width:1760px;margin:0 auto;padding:18px 28px 6px}
    h1{margin:0;font-size:42px;font-weight:1100}
    .sub{color:var(--muted);font-size:16px;margin-top:6px}

    /* ===== تخطيط TV ثلاثي الأعمدة =====
       يمين: خدمات | وسط: غرف | يسار: أقرب غرفة + صور */
    .layout{
  max-width: 1760px;
  margin: 0 auto;
  padding: 14px 28px 14px;
  display: grid;

  /* مهم: اجعل الأعمدة مرنة بدل أرقام ثابتة كبيرة */
  grid-template-columns: minmax(300px, 22vw) 1fr minmax(300px, 22vw);
  grid-template-areas: "right center left";
  gap: 16px;
  align-items: start;

  /* تثبيت التمركز */
  width: 100%;
}
    .right{ grid-area: right; }
    .center{ grid-area: center; }
    .left{ grid-area: left; }

    .section{
      background: rgba(0,0,0,.34);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      direction: rtl;
    }

    .section-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 0 0 12px 0;
      color: var(--text);
      font-weight: 1100;
      font-size: 20px;
    }
    .count{
      color: var(--muted);
      font-size: 14px;
      font-weight: 900;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 6px 10px;
      border-radius: 999px;
    }

    /* شبكة الغرف: تلقائية حسب عرض الوسط */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .card{
      background:rgba(0,0,0,.22);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(2px);
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .room-title{font-weight:1100;font-size:22px}
    .badge{
      font-size:13px;padding:7px 12px;border-radius:999px;border:1px solid var(--border);
      color:var(--muted);background:rgba(255,255,255,.03);font-weight:900
    }
    .badge.free{color:#d1fae5;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)}
    .badge.busy{color:#cffafe;border-color:rgba(45,212,191,.35);background:rgba(45,212,191,.10)}
    .timer{
      margin-top:12px; font-variant-numeric:tabular-nums; font-size:52px; font-weight:1100;
      padding:12px 12px; border-radius:14px; border:1px solid var(--border); background:rgba(0,0,0,.26);
      text-align:center; direction:ltr;
    }
    .timer.normal{color:var(--ok)} .timer.warn{color:var(--warn)}
    .timer.over{color:var(--bad);border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
    .meta{margin-top:10px;color:var(--muted);font-size:15px;line-height:1.7}
    .meta b{color:var(--text);font-weight:1100}

    /* يمين: جدول الخدمات */
    .services-table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
    }
    .services-table th, .services-table td{
      padding: 11px 10px;
      border-bottom:1px solid var(--border);
      font-size: 14px;
    }
    .services-table th{
      text-align:right;
      color: var(--muted);
      font-weight: 1100;
      background: rgba(255,255,255,.03);
    }
    .services-table td:last-child{
      text-align:left;
      direction:ltr;
      font-weight: 1100;
      color: var(--text);
      white-space: nowrap;
      min-width: 110px;
    }

    /* يسار: لوحة أقرب غرفة */
    .panel{
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: rgba(0,0,0,.18);
    }
    .line{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 0;
      border-bottom:1px solid var(--border);
    }
    .line:last-child{border-bottom:none}
    .label{color:var(--muted); font-size: 14px; font-weight: 900;}
    .value{color:var(--text); font-size: 18px; font-weight: 1100; direction:ltr;}
    .value.ar{direction:rtl}

    /* سلايد صور */
    .slideshow{
      margin-top: 12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    .slideshow img{
      width:100%;
      height: 240px;
      object-fit: cover;
      display:block;
    }
    .slideshow .cap{
      padding: 10px 12px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 1000;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }

    .copyright{
      max-width:1760px;margin:10px auto 16px;padding:0 28px;
      text-align:center;color:var(--muted);font-size:14px
    }
    /* ===== ANDROID TV 1080p PROFILE ===== */
@media (max-width: 1920px) {

  body {
    font-size: 14px;
  }

  h1 {
    font-size: 32px !important;
  }

  .sub {
    font-size: 14px !important;
  }

  .layout {
    max-width: 1600px;
    grid-template-columns: 320px minmax(720px, 1fr) 320px;
    gap: 12px;
  }

  header {
    padding: 10px 24px 4px;
  }
header,
.layout {
  width: 100%;
  margin-left: auto;
  margin-right: auto;
}
  .section {
    padding: 12px;
  }

  .section-title {
    font-size: 18px;
  }

  .room-title {
    font-size: 18px;
  }

  .timer {
    font-size: 36px !important;
    padding: 10px;
  }

  .badge {
    font-size: 12px;
    padding: 5px 10px;
  }

  .meta {
    font-size: 13px;
  }

  .services-table th,
  .services-table td {
    font-size: 13px;
    padding: 8px;
  }

  .slideshow img {
    height: 180px;
  }
}
  </style>
</head>

<body>
<header>
  <h1>حمام القدس</h1>
  <div class="sub">شاشة العرض — التحديث لحظي. الموسيقى تعمل بعد أول ضغطة من الريموت (Android TV).</div>
</header>

<div class="layout">

  <!-- ===== Right: Services ===== -->
  <aside class="right section">
    <div class="section-title">
      <span>الخدمات والأسعار</span>
      <span class="count">دج</span>
    </div>
    <table class="services-table" role="table" aria-label="الخدمات والأسعار">
      <thead>
        <tr><th>الخدمة</th><th>السعر</th></tr>
      </thead>
      <tbody>
        <tr><td>الدخول (للشخص)</td><td>400</td></tr>
        <tr><td>تمديد بعد الساعة (كل 15 دقيقة)</td><td>+100</td></tr>
        <tr><td>ساونا</td><td>حسب الطلب</td></tr>
        <tr><td>تدليك</td><td>حسب الطلب</td></tr>
      </tbody>
    </table>
  </aside>

  <!-- ===== Center: Rooms ===== -->
  <main class="center content">
    <div class="section">
      <div class="section-title">
        <span>الغرف الشاغرة</span>
        <span class="count" id="freeCount">0</span>
      </div>
      <div id="freeGrid" class="grid"></div>
    </div>

    <div style="height:16px"></div>

    <div class="section">
      <div class="section-title">
        <span>الغرف المحجوزة</span>
        <span class="count" id="busyCount">0</span>
      </div>
      <div id="busyGrid" class="grid"></div>
    </div>
  </main>

  <!-- ===== Left: Next + Slideshow ===== -->
  <aside class="left section">
    <div class="section-title">
      <span>أقرب غرفة ستفرغ</span>
      <span class="count">ضمن الساعة</span>
    </div>

    <div class="panel" id="nextPanel">
      <div class="line">
        <div class="label">الحالة</div>
        <div class="value ar" id="nextStatus">—</div>
      </div>
      <div class="line">
        <div class="label">الغرفة</div>
        <div class="value ar" id="nextRoom">—</div>
      </div>
      <div class="line">
        <div class="label">المتبقي حتى ساعة</div>
        <div class="value" id="nextRemaining">—</div>
      </div>
      <div class="line">
        <div class="label">وقت البداية</div>
        <div class="value" id="nextStart">—</div>
      </div>
    </div>

    <div class="slideshow" aria-label="عرض صور متتابع">
      <img id="slideImg" src="./assets/sauna.jpg" alt="عرض صور" />
      <div class="cap" id="slideCap">ساونا</div>
    </div>
  </aside>

</div>

<div class="copyright">جميع الحقوق محفوظة</div>

<!-- ===== Background Music for Android TV ===== -->
<audio id="bgMusic" preload="auto" loop>
  <source src="./assets/musique.mp3" type="audio/mpeg">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ===== Firebase config (كما كان عندك) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBGHRhM7iU8EEgBQGrR67uDXme7Ko94v4c",
    authDomain: "hammam-4430d.firebaseapp.com",
    projectId: "hammam-4430d",
    storageBucket: "hammam-4430d.firebasestorage.app",
    messagingSenderId: "501453146862",
    appId: "1:501453146862:web:1f4b0e5137fa3c235701ff",
    measurementId: "G-2FW2V6FHHL"
  };

  const ONE_HOUR_MS = 60 * 60 * 1000;

  // ===== Android TV music: يبدأ بعد أول ضغطة =====
  const music = document.getElementById("bgMusic");
  music.volume = 0.25; // 0..1
  let musicStarted = false;

  async function startMusicOnce(){
    if (musicStarted) return;
    musicStarted = true;
    try { await music.play(); }
    catch(e){ musicStarted = false; }
  }

  // أي زر من الريموت (OK/أسهم/Back..) يحسب تفاعل
  document.addEventListener("keydown", startMusicOnce);
  document.addEventListener("click", startMusicOnce);
  window.addEventListener("load", startMusicOnce);

  // ===== Firestore setup =====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const stateRef = doc(db, "hamam", "state");

  const freeGrid = document.getElementById("freeGrid");
  const busyGrid = document.getElementById("busyGrid");
  const freeCount = document.getElementById("freeCount");
  const busyCount = document.getElementById("busyCount");

  const nextStatus = document.getElementById("nextStatus");
  const nextRoom = document.getElementById("nextRoom");
  const nextRemaining = document.getElementById("nextRemaining");
  const nextStart = document.getElementById("nextStart");

  // ===== Slideshow =====
  const slideImg = document.getElementById("slideImg");
  const slideCap = document.getElementById("slideCap");
  const slides = [
    { src: "./assets/sauna.jpg", cap: "ساونا" },
    { src: "./assets/massage.jpg", cap: "تدليك" },
    { src: "./assets/images1.jpeg", cap: "حمام القدس" }
  ];
  let slideIndex = 0;

  function startSlideshow(){
    function show(i){
      const s = slides[i % slides.length];
      slideImg.src = s.src;
      slideCap.textContent = s.cap;
    }
    show(slideIndex);
    setInterval(() => {
      slideIndex = (slideIndex + 1) % slides.length;
      show(slideIndex);
    }, 5000);
  }

  // ===== Rooms logic (كما كان عندك) =====
  let rooms = [];

  function defaultRooms(){
    return Array.from({length:5}, (_,i)=>({ id:i+1, status:"FREE", startMs:null, persons:null }));
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function fmtHMS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

  function fmtTime(ms){
    const d = new Date(ms);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function computeDisplay(room, nowMs){
    if(room.status === "FREE" || !room.startMs){
      return {
        badgeClass:"free",
        badgeText:"فارغة",
        timerText:"—",
        timerClass:"normal",
        meta:"لا يوجد استخدام حاليًا."
      };
    }

    const elapsed = nowMs - room.startMs;

    if(elapsed < ONE_HOUR_MS){
      const remaining = ONE_HOUR_MS - elapsed;
      const timerClass = remaining <= 10*60*1000 ? "warn" : "normal";
      return {
        badgeClass:"busy",
        badgeText:"محجوزة",
        timerText: fmtHMS(remaining),
        timerClass,
        meta:`البداية: <b style="direction:ltr;display:inline-block">${fmtTime(room.startMs)}</b><br>
              المتبقي: <b style="direction:ltr;display:inline-block">${fmtHMS(remaining)}</b>`
      };
    } else {
      const over = elapsed - ONE_HOUR_MS;
      return {
        badgeClass:"busy",
        badgeText:"محجوزة (تجاوز)",
        timerText: `+${fmtHMS(over)}`,
        timerClass:"over",
        meta:`البداية: <b style="direction:ltr;display:inline-block">${fmtTime(room.startMs)}</b><br>
              التجاوز: <b style="color:var(--bad);font-weight:1100;direction:ltr;display:inline-block">+${fmtHMS(over)}</b>`
      };
    }
  }

  function findNextToFree(nowMs){
    const candidates = rooms
      .filter(r => r.status === "OCCUPIED" && r.startMs)
      .map(r => {
        const elapsed = nowMs - r.startMs;
        const remaining = ONE_HOUR_MS - elapsed;
        return { r, remaining };
      })
      .filter(x => x.remaining > 0);

    if(candidates.length === 0) return null;
    candidates.sort((a,b) => a.remaining - b.remaining);
    return candidates[0];
  }

  function render(){
    const nowMs = Date.now();
    freeGrid.innerHTML = "";
    busyGrid.innerHTML = "";

    const freeRooms = rooms.filter(r => r.status === "FREE" || !r.startMs);
    const busyRooms = rooms.filter(r => r.status === "OCCUPIED" && r.startMs);

    freeCount.textContent = String(freeRooms.length);
    busyCount.textContent = String(busyRooms.length);

    for(const room of freeRooms){
      const disp = computeDisplay(room, nowMs);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <div class="room-title">غرفة ${room.id}</div>
          <div class="badge ${disp.badgeClass}">${disp.badgeText}</div>
        </div>
        <div class="timer ${disp.timerClass}">${disp.timerText}</div>
        <div class="meta">${disp.meta}</div>
      `;
      freeGrid.appendChild(card);
    }

    for(const room of busyRooms){
      const disp = computeDisplay(room, nowMs);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <div class="room-title">غرفة ${room.id}</div>
          <div class="badge ${disp.badgeClass}">${disp.badgeText}</div>
        </div>
        <div class="timer ${disp.timerClass}">${disp.timerText}</div>
        <div class="meta">${disp.meta}</div>
      `;
      busyGrid.appendChild(card);
    }

    const next = findNextToFree(nowMs);
    if(!next){
      nextStatus.textContent = "لا توجد غرفة ستفرغ قريبًا";
      nextRoom.textContent = "—";
      nextRemaining.textContent = "—";
      nextStart.textContent = "—";
    } else {
      nextStatus.textContent = "ضمن الساعة (ستنتهي أولًا)";
      nextRoom.textContent = `غرفة ${next.r.id}`;
      nextRemaining.textContent = fmtHMS(next.remaining);
      nextStart.textContent = fmtTime(next.r.startMs);
    }
  }

  async function ensureStateDoc(){
    const snap = await getDoc(stateRef);
    if(!snap.exists()){
      await setDoc(stateRef, { rooms: defaultRooms(), updatedAt: Date.now() });
    }
  }

  (async function main(){
    await signInAnonymously(auth);
    await ensureStateDoc();

    onSnapshot(stateRef, (snap) => {
      const data = snap.data();
      rooms = (data?.rooms && Array.isArray(data.rooms) && data.rooms.length === 5)
        ? data.rooms
        : defaultRooms();
      render();
    });

    setInterval(render, 1000);
    startSlideshow();
  })();
</script>
</body>
</html>





