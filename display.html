<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حمام القدس — شاشة العرض</title>

  <style>
    :root{
      --bg:#0b1020; --muted:#93a4c7; --text:#e8eefc;
      --ok:#2dd4bf; --warn:#fbbf24; --bad:#ef4444;
      --border:rgba(255,255,255,.08); --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --safe: 24px;
    }
    *{box-sizing:border-box}

    /* خلفية بصورة + طبقة تعتيم لرفع وضوح النص */
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      padding: var(--safe);
      background:
        linear-gradient(0deg, rgba(11,16,32,.70), rgba(11,16,32,.70)),
        url("./assets/images2.jpeg") center/cover no-repeat;
    }

    header{
      max-width:1600px;
      width:100%;
      margin-left:auto;
      margin-right:auto;
      padding: 10px 10px 6px;

      text-align: center;
    }
    h1{margin:0;font-size:54px;font-weight:1100}
    .sub{color:var(--muted);font-size:14px;margin-top:6px}

    .layout{
      max-width:1600px;
      width:100%;
      margin-left:auto;
      margin-right:auto;
      padding: 8px 10px 70px; /* مساحة للشريط المتحرك */
    }

    .section{
      background: rgba(0,0,0,.34);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .section-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 0 0 12px 0;
      font-weight: 1100;
      font-size: 18px;
    }
    .count{
      color: var(--muted);
      font-size: 13px;
      font-weight: 900;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 5px 9px;
      border-radius: 999px;
      direction:ltr;
    }

    /* شبكة ثابتة 3 أعمدة (صف1:3) (صف2:2 + سلايد بالوسط) */
    .roomsGrid{
      direction:ltr; /* لمنع انعكاس ترتيب الخلايا بسبب RTL */
      display:grid;
      grid-template-columns: repeat(3, minmax(280px, 1fr));
      gap: 16px;
    }
    .roomCard, .slideCard{ direction:rtl; }

    .card{
      background:rgba(0,0,0,.22);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      backdrop-filter: blur(2px);
    }

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .room-title{font-weight:1100;font-size:18px}
    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      color:var(--muted);background:rgba(255,255,255,.03);font-weight:900
    }
    .badge.free{color:#d1fae5;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)}
    .badge.busy{color:#cffafe;border-color:rgba(45,212,191,.35);background:rgba(45,212,191,.10)}

    .timer{
      margin-top:12px;
      font-variant-numeric:tabular-nums;
      font-size:34px;
      font-weight:1100;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.26);
      text-align:center;
      direction:ltr;
    }
    .timer.normal{color:var(--ok)}
    .timer.warn{color:var(--warn)}
    .timer.over{color:var(--bad);border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}

    .meta{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.7}
    .meta b{color:var(--text);font-weight:1100}

    /* بطاقة السلايد في الوسط (بحجم الغرفة) */
    .slideCard{
      background:rgba(0,0,0,.22);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .slideBox{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(0,0,0,.16);
    }
    .slideBox img{
      width:100%;
      height: 200px;
      object-fit:cover;
      display:block;
    }
    .slideBox .cap{
      padding:10px 12px;
      color:var(--muted);
      font-size:13px;
      font-weight:1000;
      border-top:1px solid var(--border);
      background: rgba(0,0,0,.10);
    }

    /* شريط متحرك أسفل الشاشة: من اليسار إلى اليمين */
    .ticker{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding: 10px 0;
      overflow: hidden;
    }
    .ticker__track{
      width: 100%;
      white-space: nowrap;
      will-change: transform;
      animation: ticker-ltr 18s linear infinite;
    }
    .ticker__item{
      display:inline-block;
      padding: 0 28px;
      font-weight:1100;
      color:var(--text);
      opacity:.95;
    }
    @keyframes ticker-ltr{
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Android TV: تصغير بسيط إن احتجت */
    body{ zoom: 0.90; }
  </style>
</head>

<body>
<header>
  <h1>حمام القدس</h1>
  <div class="sub">نرحب بضيوفنا الكرام</div>
</header>

<div class="layout">
  <main class="content">
    <div class="section">
      <div class="section-title">
        <span>الغرف</span>
        <span class="count" id="freeCount">0</span>
      </div>

      <div id="roomsGrid" class="roomsGrid"></div>
    </div>
  </main>
</div>

<!-- شريط متحرك للخدمات والأسعار -->
<div class="ticker" aria-label="الخدمات والأسعار">
  <div class="ticker__track" id="tickerTrack">
    <span class="ticker__item">
      التسعير: السعر الأساسي = عدد الأشخاص × 400 دج (1–4) — بعد الساعة: كل ربع ساعة +100 دج — ساونا: حسب الطلب — تدليك: حسب الطلب
    </span>
  </div>
</div>

  <!-- شريط متحرك للشركة المصنعة -->
<div class="ticker" aria-label="الخدمات والأسعار">
  <div class="ticker__track" id="tickerTrack">
    <span class="ticker__item">
      شركة الخدمات الذكية المقر سطيف رفم الهاتف 0658756549 الفايسبوك 
    </span>
  </div>
</div>

<!-- ===== Background Music for Android TV ===== -->
<audio id="bgMusic" preload="auto" loop>
  <source src="./assets/music.mp3" type="audio/mpeg">
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ===== Firebase config =====
  const firebaseConfig = {
    apiKey: "AIzaSyBGHRhM7iU8EEgBQGrR67uDXme7Ko94v4c",
    authDomain: "hammam-4430d.firebaseapp.com",
    projectId: "hammam-4430d",
    storageBucket: "hammam-4430d.firebasestorage.app",
    messagingSenderId: "501453146862",
    appId: "1:501453146862:web:1f4b0e5137fa3c235701ff",
    measurementId: "G-2FW2V6FHHL"
  };

  const ONE_HOUR_MS = 60 * 60 * 1000;

  // ===== Android TV Music: يبدأ بعد أول ضغطة =====
  const music = document.getElementById("bgMusic");
  music.volume = 0.25;
  let musicStarted = false;

  async function startMusicOnce(){
    if (musicStarted) return;
    musicStarted = true;
    try { await music.play(); }
    catch(e){ musicStarted = false; }
  }
  document.addEventListener("keydown", startMusicOnce);
  document.addEventListener("click", startMusicOnce);
  window.addEventListener("load", startMusicOnce);

  // ===== Firestore setup =====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const stateRef = doc(db, "hamam", "state");

  const roomsGrid = document.getElementById("roomsGrid");
  const freeCount = document.getElementById("freeCount");

  let rooms = [];

  let uiBuilt = false;

  function defaultRooms(){
    return Array.from({length:5}, (_,i)=>({ id:i+1, status:"FREE", startMs:null, persons:null }));
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function fmtHMS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

  function fmtTime(ms){
    const d = new Date(ms);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function computeDisplay(room, nowMs){
    if(room.status === "FREE" || !room.startMs){
      return {
        badgeClass:"free",
        badgeText:"فارغة",
        timerText:"—",
        timerClass:"normal",
        meta:"لا يوجد استخدام حاليًا."
      };
    }

    const elapsed = nowMs - room.startMs;

    if(elapsed < ONE_HOUR_MS){
      const remaining = ONE_HOUR_MS - elapsed;
      const timerClass = remaining <= 10*60*1000 ? "warn" : "normal";
      return {
        badgeClass:"busy",
        badgeText:"محجوزة",
        timerText: fmtHMS(remaining),
        timerClass,
        meta:`البداية: <b style="direction:ltr;display:inline-block">${fmtTime(room.startMs)}</b><br>
              المتبقي: <b style="direction:ltr;display:inline-block">${fmtHMS(remaining)}</b>`
      };
    } else {
      const over = elapsed - ONE_HOUR_MS;
      return {
        badgeClass:"busy",
        badgeText:"محجوزة (تجاوز)",
        timerText: `+${fmtHMS(over)}`,
        timerClass:"over",
        meta:`البداية: <b style="direction:ltr;display:inline-block">${fmtTime(room.startMs)}</b><br>
              التجاوز: <b style="color:var(--bad);font-weight:1100;direction:ltr;display:inline-block">+${fmtHMS(over)}</b>`
      };
    }
  }

  function makeRoomCard(room, nowMs){
    const disp = computeDisplay(room, nowMs);
    const card = document.createElement("div");
    card.className = "card roomCard";
    card.innerHTML = `
      <div class="row">
        <div class="room-title">غرفة ${room.id}</div>
        <div class="badge ${disp.badgeClass}">${disp.badgeText}</div>
      </div>
      <div class="timer ${disp.timerClass}">${disp.timerText}</div>
      <div class="meta">${disp.meta}</div>
    `;
    return card;
  }

  function makeSlideCard(totalRooms){
    const card = document.createElement("div");
    card.className = "slideCard";
    card.innerHTML = `
      <div class="section-title" style="margin:0 0 10px 0">
        <span>خدماتنا</span>
        <span>nos services</span>
      </div>
      <div class="slideBox">
        <img id="slideImg" src="./assets/sauna.jpg" alt="عرض صور" />
        <div class="cap" id="slideCap">ساونا</div>
      </div>
    `;
    return card;
  }

  function startInlineSlideshow(){
  // شغّل الـ interval مرة واحدة فقط
  if (window.__slideInterval) return;

  window.__slides = [
    { src: "./assets/sauna.jpg",   cap: "ساونا" },
    { src: "./assets/massage.jpg", cap: "تدليك" },
    { src: "./assets/images1.jpeg",cap: "حمام القدس" }
  ];
  window.__slideIndex = 0;

  // عيّن أول صورة فورًا (حتى لو كان العنصر يتبدّل)
  function applySlide(){
    const img = document.getElementById("slideImg");
    const cap = document.getElementById("slideCap");
    if(!img || !cap) return; // بطاقة السلايد غير موجودة الآن

    const s = window.__slides[window.__slideIndex];
    img.src = s.src;
    cap.textContent = s.cap;
  }

  applySlide();

  window.__slideInterval = setInterval(() => {
    window.__slideIndex = (window.__slideIndex + 1) % window.__slides.length;
    applySlide(); // مهم: يلتقط العنصر الحالي بعد كل render
  }, 5000);
}

  function buildUI(){
  const nowMs = Date.now();

  // نبني DOM مرة واحدة فقط
  roomsGrid.innerHTML = "";

  const sorted = [...rooms].sort((a,b) => a.id - b.id);

  // تحديث العدد الفوري
  const freeRoomsCount = sorted.filter(r => r.status === "FREE" || !r.startMs).length;
  freeCount.textContent = String(freeRoomsCount);

  // إن لم تكن 5 غرف: نعرض الغرف فقط
  if(sorted.length !== 5){
    for(const r of sorted){
      const card = makeRoomCard(r, nowMs);
      // مهم: نخزن id الغرفة على البطاقة للتحديث لاحقًا
      card.dataset.roomId = String(r.id);
      roomsGrid.appendChild(card);
    }
    uiBuilt = true;
    return;
  }

  // صف 1: 1,2,3
  for(let i=0;i<3;i++){
    const card = makeRoomCard(sorted[i], nowMs);
    card.dataset.roomId = String(sorted[i].id);
    roomsGrid.appendChild(card);
  }

  // صف 2: 4, [SLIDE], 5
  const card4 = makeRoomCard(sorted[3], nowMs);
  card4.dataset.roomId = String(sorted[3].id);
  roomsGrid.appendChild(card4);

  roomsGrid.appendChild(makeSlideCard(sorted.length));

  const card5 = makeRoomCard(sorted[4], nowMs);
  card5.dataset.roomId = String(sorted[4].id);
  roomsGrid.appendChild(card5);

  uiBuilt = true;

  // ابدأ السلايد مرة واحدة
  startInlineSlideshow();
}

function updateTimersOnly(){
  if(!uiBuilt) return;

  const nowMs = Date.now();
  const sorted = [...rooms].sort((a,b) => a.id - b.id);

  // تحديث عدد الغرف الفارغة كل ثانية
  const freeRoomsCount = sorted.filter(r => r.status === "FREE" || !r.startMs).length;
  freeCount.textContent = String(freeRoomsCount);

  // تحديث كل بطاقة غرفة حسب roomId المخزن
  const cards = roomsGrid.querySelectorAll(".roomCard");
  for(const card of cards){
    const id = Number(card.dataset.roomId);
    const room = sorted.find(r => r.id === id);
    if(!room) continue;

    const disp = computeDisplay(room, nowMs);

    const badge = card.querySelector(".badge");
    const timer = card.querySelector(".timer");
    const meta  = card.querySelector(".meta");

    if(badge){
      badge.className = `badge ${disp.badgeClass}`;
      badge.textContent = disp.badgeText;
    }
    if(timer){
      timer.className = `timer ${disp.timerClass}`;
      timer.textContent = disp.timerText;
    }
    if(meta){
      meta.innerHTML = disp.meta;
    }
  }
}

  
  async function ensureStateDoc(){
    const snap = await getDoc(stateRef);
    if(!snap.exists()){
      await setDoc(stateRef, { rooms: defaultRooms(), updatedAt: Date.now() });
    }
  }

  (async function main(){
  await signInAnonymously(auth);
  await ensureStateDoc();

  onSnapshot(stateRef, (snap) => {
    const data = snap.data();
    rooms = (data?.rooms && Array.isArray(data.rooms) && data.rooms.length >= 1)
      ? data.rooms
      : defaultRooms();

    uiBuilt = false;
    buildUI();
    updateTimersOnly();
  });

  setInterval(updateTimersOnly, 1000);
})();


</script>
</body>
</html>


